"use strict";(self.webpackChunkheadless_doc=self.webpackChunkheadless_doc||[]).push([[2781],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),l=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=l(e.components);return r.createElement(p.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,p=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=l(n),h=a,m=u["".concat(p,".").concat(h)]||u[h]||c[h]||i;return n?r.createElement(m,o(o({ref:t},d),{},{components:n})):r.createElement(m,o({ref:t},d))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=h;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[u]="string"==typeof e?e:a,o[1]=s;for(var l=2;l<i;l++)o[l]=n[l];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},5386:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var r=n(7462),a=(n(7294),n(3905));const i={sidebar_position:0,slug:"/wordpress-integration/previews"},o="Previews",s={unversionedId:"WordPress Integration/previews",id:"WordPress Integration/previews",title:"Previews",description:"The preview feature requires the HeadstartWP plugin installed. The preview functionality is built on top of Next.js preview API. It uses a short-lived JWT token generated on the WordPress side that can only be used for previewing, this means it is not necessary to set up a hardcoded secret between WP and Next.js.",source:"@site/documentation/06-WordPress Integration/previews.md",sourceDirName:"06-WordPress Integration",slug:"/wordpress-integration/previews",permalink:"/docs/learn/wordpress-integration/previews",draft:!1,editUrl:"https://github.com/10up/headstartwp/tree/trunk/docs/documentation/06-WordPress Integration/previews.md",tags:[],version:"current",lastUpdatedBy:"N\xedcholas Andr\xe9",lastUpdatedAt:1710434842,formattedLastUpdatedAt:"Mar 14, 2024",sidebarPosition:0,frontMatter:{sidebar_position:0,slug:"/wordpress-integration/previews"},sidebar:"tutorialSidebar",previous:{title:"Rendering Blocks in React Native",permalink:"/docs/learn/gutenberg/rendering-blocks-in-react-native"},next:{title:"Multisite",permalink:"/docs/learn/wordpress-integration/multisite"}},p={},l=[{value:"Usage",id:"usage",level:2},{value:"<code>previewHandler</code> options",id:"previewhandler-options",level:3},{value:"<code>preparePreviewData</code>",id:"preparepreviewdata",level:4},{value:"<code>getRedirectPath</code>",id:"getredirectpath",level:4},{value:"<code>onRedirect</code>",id:"onredirect",level:4},{value:"The <code>usePostLinkForRedirect</code> setting",id:"the-usepostlinkforredirect-setting",level:3},{value:"FAQ",id:"faq",level:2}],d={toc:l};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"previews"},"Previews"),(0,a.kt)("p",null,"The preview feature requires the HeadstartWP plugin installed. The preview functionality is built on top of ",(0,a.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/advanced-features/preview-mode"},"Next.js preview API"),". It uses a short-lived JWT token generated on the WordPress side that can only be used for previewing, this means it is not necessary to set up a hardcoded secret between WP and Next.js."),(0,a.kt)("p",null,"For previews to work, make sure the frontend URL is entered in WP settings as per instructions in ",(0,a.kt)("a",{parentName:"p",href:"/learn/getting-started/installing-wordpress-plugin"},"Installing WordPress Plugin"),"."),(0,a.kt)("p",null,"The logic for generating the JWT token and redirecting it to the preview endpoint can be seen ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/10up/headstartwp/blob/develop/wp/headless-wp/includes/classes/Preview/preview.php"},"here"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-php"},"$token = PreviewToken::generate(\n    [\n        'type'      => 'preview',\n        'post_type' => $post_type,\n        'post_id'   => $post_id,\n    ]\n);\n\n$preview_url = sprintf(\n    '%sapi/preview?post_id=%d&post_type=%s&is_revision=%s&token=%s',\n    trailingslashit( Plugin::get_react_url() ),\n    $post_id,\n    $post_type,\n    $is_revision ? '1' : '0',\n    $token\n);\n\nwp_redirect( $preview_url );\ndie();\n")),(0,a.kt)("p",null,"Below is a summary of the preview workflow."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"First a token of type ",(0,a.kt)("inlineCode",{parentName:"li"},"preview")," is generated"),(0,a.kt)("li",{parentName:"ul"},"The token encodes the post type and post id."),(0,a.kt)("li",{parentName:"ul"},"A preview URL is generated assuming the preview endpoint lives at ",(0,a.kt)("inlineCode",{parentName:"li"},"/api/preview")),(0,a.kt)("li",{parentName:"ul"},"WordPress redirects to the preview endpoint"),(0,a.kt)("li",{parentName:"ul"},"The token is sent alongside the post_type, post_id and a boolean indicating whether the post being previewed is a revision or not. "),(0,a.kt)("li",{parentName:"ul"},"The token is verified against the parameters and the token is used to fetch the post's draft/revision content.")),(0,a.kt)("h2",{id:"usage"},"Usage"),(0,a.kt)("p",null,"The Next.js project ",(0,a.kt)("strong",{parentName:"p"},"must")," expose an ",(0,a.kt)("inlineCode",{parentName:"p"},"api/preview")," endpoint that uses the ",(0,a.kt)("a",{parentName:"p",href:"/api/modules/headstartwp_next/#previewhandler"},"previewHandler"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"//src/pages/api/preview.js\nimport { previewHandler } from '@headstartwp/next';\n\n/**\n * The Preview endpoint just needs to proxy the default preview handler\n *\n * @param {*} req Next.js request object\n * @param {*} res  Next.js response object\n *\n * @returns\n */\nexport default async function handler(req, res) {\n    return previewHandler(req, res);\n}\n")),(0,a.kt)("p",null,"That's all that is needed to enable WordPress preview."),(0,a.kt)("p",null,"While previewing the URL will not reflect the actual URL of the post, but instead, it will contain the post id and a ",(0,a.kt)("inlineCode",{parentName:"p"},"-preview")," suffix."),(0,a.kt)("h3",{id:"previewhandler-options"},(0,a.kt)("inlineCode",{parentName:"h3"},"previewHandler")," options"),(0,a.kt)("h4",{id:"preparepreviewdata"},(0,a.kt)("inlineCode",{parentName:"h4"},"preparePreviewData")),(0,a.kt)("p",null,"This allows you to alter the preview data object before it is stored by Next.js (i.e before calling ",(0,a.kt)("inlineCode",{parentName:"p"},"res.setPreviewData"),"). You can use this if you need to add additional fields to preview data object."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export default async function handler(req, res) {\n    return previewHandler(req, res, {\n        preparePreviewData(req, res, post, previewData) {\n            return { ...previewData, name: post.name };\n        },\n    });\n}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"name")," would now be available in the context object of ",(0,a.kt)("inlineCode",{parentName:"p"},"getServerSideProps")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"getStaticProps")," (",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.previewData"),");"),(0,a.kt)("h4",{id:"getredirectpath"},(0,a.kt)("inlineCode",{parentName:"h4"},"getRedirectPath")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"This option was added in ",(0,a.kt)("inlineCode",{parentName:"p"},"@headstartwp/next@1.1.0"),".")),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"A better alternative is using ",(0,a.kt)("inlineCode",{parentName:"p"},"preview.usePostLinkForRedirect"),". With this setting, you can set up previews so that it uses the ",(0,a.kt)("inlineCode",{parentName:"p"},"post.link")," property of the post for redirecting to the appropriate path/route. This requires that your WordPress permalink matches the Next.js route structure. Check out the docs for ",(0,a.kt)("a",{parentName:"p",href:"/learn/wordpress-integration/previews#the-usepostlinkforredirect-setting"},"preview.usePostLinkForRedirect"),".")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"getRedirectPath")," option allows you to customize the redirected URL that should handle the preview request. This can be useful if you have implemented a non-standard URL structure. For instance, if the permalink for your posts is ",(0,a.kt)("inlineCode",{parentName:"p"},"/%category%/%postname%/")," you could create a ",(0,a.kt)("inlineCode",{parentName:"p"},"/src/pages/[category]/[...path.js]")," route to handle single post. However, once you do that the ",(0,a.kt)("inlineCode",{parentName:"p"},"previewHandler")," doesn't know how to redirect to that URL and as such you will have to provide your own redirect handling."),(0,a.kt)("p",null,"The framework will also use this value to restrict the preview cookie to the post being previewed to avoid bypassing ",(0,a.kt)("inlineCode",{parentName:"p"},"getStaticProps")," until the cookie expires or the browser is closed. See the ",(0,a.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/pages/building-your-application/configuring/preview-mode#specify-the-preview-mode-duration"},"Next.js docs")," for more info."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"import { getPostTerms } from '@headstartwp/core';\nimport { previewHandler } from '@headstartwp/next';\n\nexport default async function handler(req, res) {\n    return previewHandler(req, res, {\n        getRedirectPath(defaultRedirectPath, post) {\n            const { type, id, slug } = post;\n\n            if (type === 'post') {\n                const terms = getPostTerms(post);\n                \n                if (Array.isArray(terms?.category) && terms.category.length > 0) {\n                    const [category] = terms.category;\n\n                    return `/${categorySlug}/${id}/${slug || id}`;\n                }\n            }\n\n            return defaultRedirectPath\n        },\n    });\n}\n")),(0,a.kt)("h4",{id:"onredirect"},(0,a.kt)("inlineCode",{parentName:"h4"},"onRedirect")),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Instead of implementing ",(0,a.kt)("inlineCode",{parentName:"p"},"onRedirect")," we recommend implementing ",(0,a.kt)("inlineCode",{parentName:"p"},"getRedirectPath")," instead as that will only enable the preview cookie for\nthe post being previewed.")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"onRedirect")," gives you full access to the ",(0,a.kt)("inlineCode",{parentName:"p"},"req")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"res")," objects. If you do need implement this function we recommend also implementing ",(0,a.kt)("inlineCode",{parentName:"p"},"getRedirectPath"),"."),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"When handling redirects yourself, make sure to always append ",(0,a.kt)("inlineCode",{parentName:"p"},"-preview=true")," to the end of the redirected URL.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"import { getPostTerms } from '@headstartwp/core';\nimport { previewHandler } from '@headstartwp/next';\n\nexport default async function handler(req, res) {\n    return previewHandler(req, res, {\n        onRedirect(req, res, previewData) {\n            return res.redirect('/custom-path-preview-true');\n        },\n    });\n}\n")),(0,a.kt)("h3",{id:"the-usepostlinkforredirect-setting"},"The ",(0,a.kt)("inlineCode",{parentName:"h3"},"usePostLinkForRedirect")," setting"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"preview.usePostLinkForRedirect")," was added in ",(0,a.kt)("inlineCode",{parentName:"p"},"@headstartwp/next@1.3.3")," and it tells the preview handler to use the actual post permalink to figure out where it should redirect to. With this setting, previewing a post will automatically redirect to a route in Next.js based on the permalink structure set in WordPress. As an example let's say you have a custom post type called ",(0,a.kt)("inlineCode",{parentName:"p"},"news")," and its permalink structure is ",(0,a.kt)("inlineCode",{parentName:"p"},"/news/news-name"),". If your Next.js URL structure strictly follows that pattern you would have a route at ",(0,a.kt)("inlineCode",{parentName:"p"},"pages/news/[...path].js"),". Therefore HeadstartWP can infer the proper path to a preview request for a post of type ",(0,a.kt)("inlineCode",{parentName:"p"},"news"),"."),(0,a.kt)("p",null,"This becomes even more useful when you have a more complicated permalink structure, let's say your ",(0,a.kt)("inlineCode",{parentName:"p"},"news")," post type adds the category name to the url such as ",(0,a.kt)("inlineCode",{parentName:"p"},"/news/political/news-name"),". If both your Next.js project and WordPress are following the same permalink structure, no additional logic is required to get previews to work. Previously permalinks like this would require providing custom logic in ",(0,a.kt)("inlineCode",{parentName:"p"},"getRedirectPath"),"."),(0,a.kt)("p",null,"Note that by default, ",(0,a.kt)("inlineCode",{parentName:"p"},"draft")," posts will not have a pretty permalink, instead, they have something like ",(0,a.kt)("inlineCode",{parentName:"p"},"domain.com/?p=id")," so HeadstartWP adds a new rest field for all public post types called: ",(0,a.kt)("inlineCode",{parentName:"p"},"_headless_wp_preview_link")," which will return a pretty permalink even for draft posts. This field will be used by the previewHandler for draft posts."),(0,a.kt)("p",null,"If you are overriding permalink in WordPress via filter you must ensure that draft posts have a fallback post name. e.g: "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-php"},"// adds category to the news permalink and prefix it with \"newsroom\"\nadd_filter(\n    'post_type_link',\n    function ( $post_link, $post ) {\n        if ( 'news' !== $post->post_type ) {\n            return $post_link;\n        }\n\n        // draft posts won't have `$post->post_name` set.\n        $post_name = empty( $post->post_name ) ? sanitize_title( $post->post_title ) : $post->post_name;\n        $post_name = empty( $post_name ) ? $post->ID : $post_name;\n\n        $fallback = esc_url( home_url( sprintf( 'newsroom/%s', $post_name ) ) );\n\n        $news_types = wp_get_post_terms( $post->ID, 'category', [ 'fields' => 'slugs' ] );\n\n        if (\n        is_wp_error( $news_types ) ||\n        ! is_array( $news_types ) ||\n        ! count( $news_types ) > 0\n        ) {\n            return $fallback;\n        }\n\n        return esc_url( home_url( sprintf( 'newsroom/%s/%s', $news_types[0], $post_name ) ) );\n    },\n    10,\n    2\n);\n")),(0,a.kt)("p",null,"You can also use a placeholder instead of manually handling post_name yourself e.g:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-php"},"$post_name = empty( $post->post_name ) ? '%postname%' : $post->post_name;\n")),(0,a.kt)("p",null,"When building the permalink for draft posts the framework will automatically replace ",(0,a.kt)("inlineCode",{parentName:"p"},"%postname")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"%pagename%")," with the post_name (based on the title) or a fallback to post id."),(0,a.kt)("h2",{id:"faq"},"FAQ"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"After a while, the preview URL stops working")),(0,a.kt)("p",null,"The JWT token expires after 5 min by default, after this period, open another preview window from WordPress to preview the post. The Next.js preview cookie also last for only 5 minutes."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"I'm unable to preview a custom post type")),(0,a.kt)("p",null,"Make sure you defined the right ",(0,a.kt)("inlineCode",{parentName:"p"},"single")," property when registering the custom post type. See ",(0,a.kt)("a",{parentName:"p",href:"/learn/getting-started/headless-config/#customposttypes"},"headless config docs"),". The ",(0,a.kt)("inlineCode",{parentName:"p"},"single")," property must match the route prefix for the custom post type."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"I have a custom authentication using the Authorization header, how can I use the preview functionality?")),(0,a.kt)("p",null,"Make sure you have HeadstartWP plugin >= 1.0.1, ",(0,a.kt)("inlineCode",{parentName:"p"},"@headstartwp/core")," >= 1.3.1 and ",(0,a.kt)("inlineCode",{parentName:"p"},"@headstartwp/next"),">= 1.3.1. Then in your ",(0,a.kt)("inlineCode",{parentName:"p"},"headstartwp.config.js")," add the following config:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"module.exports = {\n    // other configs.\n    // ...\n\n    preview: {\n        alternativeAuthorizationHeader: true\n    }\n}\n")),(0,a.kt)("p",null,"This will tell HeadstartWP to use an alternative header (",(0,a.kt)("inlineCode",{parentName:"p"},"X-HeadstartWP-Authorization"),") instead of the default ",(0,a.kt)("inlineCode",{parentName:"p"},"Authorization")," header."))}u.isMDXComponent=!0}}]);